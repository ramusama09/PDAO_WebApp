@page
@model PDAO_WebApp.Pages.ID_Cards.ID_CreateModel
@{
    ViewData["Title"] = "Create PWD ID Card";
}

<link rel="stylesheet" href="~/css/id_create.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="~/js/github-config.js"></script>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mb-0" id="loadingMessage">Loading...</h5>
                <p class="text-muted mt-2" id="loadingDescription">Please wait while we process your request...</p>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <h2 class="mb-4">PWD ID Card Generator</h2>
    
    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        var statusMessageClass = Model.StatusMessage.StartsWith("Error") ? "danger" : "success";
        <div class="alert alert-@statusMessageClass alert-dismissible fade show" role="alert">
            @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    <form method="post" id="idCardForm" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Front ID Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="pwdIdNo" class="form-label required">PWD ID No.</label>
                            <input type="text" class="form-control" id="pwdIdNo" name="CardInfo.PwdIdNo" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="firstName" class="form-label required">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="CardInfo.FirstName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="middleName" class="form-label">Middle Name</label>
                            <input type="text" class="form-control" id="middleName" name="CardInfo.MiddleName">
                        </div>
                        
                        <div class="mb-3">
                            <label for="lastName" class="form-label required">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="CardInfo.LastName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="suffix" class="form-label">Suffix</label>
                            <input type="text" class="form-control" id="suffix" name="CardInfo.Suffix" placeholder="Jr., Sr., III, etc.">
                        </div>
                        
                        <div class="mb-3">
                            <label for="disabilityType" class="form-label required">Type of Disability</label>
                            <select class="form-select" id="disabilityType" name="CardInfo.DisabilityType" required>
                                <option value="" disabled>Select Disability Type</option>
                                <option value="Visual Impairment">Visual Impairment</option>
                                <option value="Hearing Impairment">Hearing Impairment</option>
                                <option value="Orthopedic Disability">Orthopedic Disability</option>
                                <option value="Learning Disability">Learning Disability</option>
                                <option value="Intellectual Disability">Intellectual Disability</option>
                                <option value="Psychosocial Disability">Psychosocial Disability</option>
                                <option value="Multiple Disabilities">Multiple Disabilities</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="signatureFile" class="form-label">Signature</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="signatureFile" name="SignatureFile" accept="image/*">
                                <button class="btn btn-outline-secondary" type="button" id="signaturePadBtn">
                                    <i class="bi bi-pencil-fill"></i> Draw Signature
                                </button>
                            </div>
                            <small class="text-muted">Upload an image of your signature or draw it below</small>
                            
                            <!-- Signature Pad modal -->
                            <div class="modal fade" id="signaturePadModal" tabindex="-1" aria-labelledby="signaturePadModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="signaturePadModalLabel">Draw Your Signature</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="signature-pad-container">
                                                <canvas id="signaturePad" class="signature-pad"></canvas>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" id="clearSignatureBtn">Clear</button>
                                            <button type="button" class="btn btn-primary" id="saveSignatureBtn">Save Signature</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="expirationDate" class="form-label required">Expiration Date</label>
                            <input type="date" class="form-control" id="expirationDate" name="CardInfo.ExpirationDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="photoFile" class="form-label">ID Photo</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="photoFile" name="PhotoFile" accept="image/*" capture="environment">
                                <button class="btn btn-outline-secondary" type="button" id="cameraBtn">
                                    <i class="bi bi-camera-fill"></i> Use Camera
                                </button>
                            </div>
                            <small class="text-muted">2x2 ID picture with white background</small>
                            
                            <!-- Camera modal -->
                            <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="cameraModalLabel">Take ID Photo</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="camera-container">
                                                <!-- Camera selection -->
                                                <div class="mb-3">
                                                    <label for="cameraSelect" class="form-label">Select Camera</label>
                                                    <select class="form-select" id="cameraSelect">
                                                        <option value="">Loading cameras...</option>
                                                    </select>
                                                </div>
                                                
                                                <!-- Camera preview -->
                                                <div class="camera-preview-container">
                                                    <video id="cameraFeed" autoplay playsinline class="camera-preview"></video>
                                                    <canvas id="photoCanvas" style="display: none;"></canvas>
                                                    <div class="camera-overlay">
                                                        <div class="camera-guide">
                                                            <div class="guide-text">Align face within the frame</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Captured photo preview -->
                                                <div class="captured-preview-container d-none">
                                                    <img id="capturedPhoto" class="captured-preview" alt="Captured photo">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <div class="camera-controls">
                                                <button type="button" class="btn btn-secondary" id="cancelPhotoBtn" data-bs-dismiss="modal">Cancel</button>
                                                <button type="button" class="btn btn-primary" id="switchCameraBtn">
                                                    <i class="bi bi-arrow-repeat"></i> Switch Camera
                                                </button>
                                                <button type="button" class="btn btn-success" id="capturePhotoBtn">
                                                    <i class="bi bi-camera-fill"></i> Take Photo
                                                </button>
                                            </div>
                                            <div class="preview-controls d-none">
                                                <button type="button" class="btn btn-warning" id="retakePhotoBtn">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Retake
                                                </button>
                                                <button type="button" class="btn btn-success" id="usePhotoBtn">
                                                    <i class="bi bi-check-lg"></i> Use Photo
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Back ID Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="addressLine1" class="form-label required">Address Line 1</label>
                            <input type="text" class="form-control" id="addressLine1" name="CardInfo.AddressLine1" placeholder="Apt/House Number, Bldg Name, Str Name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="addressLine2" class="form-label required">Address Line 2</label>
                            <input type="text" class="form-control" id="addressLine2" name="CardInfo.AddressLine2" placeholder="Brgy, City, Country, Zip Code" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateOfBirth" class="form-label required">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="CardInfo.DateOfBirth" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateIssued" class="form-label required">Date Issued</label>
                            <input type="date" class="form-control" id="dateIssued" name="CardInfo.DateIssued" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sex" class="form-label required">Sex</label>
                            <select class="form-select" id="sex" name="CardInfo.Sex" required>
                                <option value="" disabled>Select Sex</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bloodType" class="form-label required">Blood Type</label>
                            <select class="form-select" id="bloodType" name="CardInfo.BloodType" required>
                                <option value="">Select Blood Type</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emergencyContactName" class="form-label required">Emergency Contact Name</label>
                            <input type="text" class="form-control" id="emergencyContactName" name="CardInfo.EmergencyContactName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emergencyContactNo" class="form-label required">Emergency Contact No.</label>
                            <input type="tel" class="form-control" maxlength="11" id="emergencyContactNo" name="CardInfo.EmergencyContactNo" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mb-5">
            <button type="button" id="saveIdBtn" class="btn btn-primary">Save ID Card</button>
            <button type="button" id="previewBtn" class="btn btn-secondary">Preview ID Card</button>
        </div>
    </form>
    
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">ID Card Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="idCardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="front-tab" data-bs-toggle="tab" data-bs-target="#front-tab-pane" type="button" role="tab">Front</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="back-tab" data-bs-toggle="tab" data-bs-target="#back-tab-pane" type="button" role="tab">Back</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="idCardTabContent">
                        <div class="tab-pane fade show active" id="front-tab-pane" role="tabpanel" aria-labelledby="front-tab" tabindex="0">
                            <!-- Front ID Preview -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card-container">
                                        <div class="card pwd-card">
                                            <div class="header">
                                                <div class="row p-0 m-0" style="height: 100px;">
                                                    <div class="col-3 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PH_Flag.webp" alt="Philippine Flag" class="flag" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-6 text-center p-0 m-0 d-flex flex-column justify-content-center">
                                                        <h5 class="mb-0 fw-bold">REPUBLIC OF THE PHILIPPINES</h5>
                                                        <h4 class="mb-0 helvetica shadowed">CITY OF PARAÑAQUE</h4>
                                                        <small>Persons with Disability Affairs Office</small>
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PQ_Logo.jpg" alt="City Seal" class="logo" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/BP_Logo.jpg" alt="Bagong Pilipinas Logo" class="logo" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PDAO_Logo.png" alt="PWD Logo" class="logo" style="max-height: 60px;">
                                                    </div>
                                                </div>
                                                <div class="row mt-2 p-0 m-0">
                                                    <div class="col-3"></div>
                                                    <div class="col-6 text-center p-0 m-0">
                                                        <strong>PWD ID NO: </strong><span class="underlined-text text-space" id="preview-pwdid">0000-0000-0000-0000</span>
                                                    </div>
                                                    <div class="col-3"></div>
                                                </div>
                                            </div>

                                            <div class="content">
                                                <div class="row p-0 m-0">
                                                    <div class="col-md-3 p-0 m-0">
                                                        <div class="photo-box">
                                                            <img src="~/img/default_face.jpg" id="preview-photo">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-fullname">Juan Dela Cruz</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Name</p>
                                                            </div>
                                                        </div>
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-disability">Insert Disability</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Type of Disability</p>
                                                            </div>
                                                        </div>
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-signature">Insert Signature</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Signature</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 m-0 p-0">
                                                        <div class="photo-box-no-border p-1">
                                                            <img src="~/img/qr_sample.png" alt="ID Photo">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-4">
                                                    <div class="col">
                                                        <strong>Expires on: </strong><span class="underlined-text" id="preview-expiry">Month DD, 20XX</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="footer">
                                                VALID ANYWHERE IN THE PHILIPPINES
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="back-tab-pane" role="tabpanel" aria-labelledby="back-tab" tabindex="0">
                            <!-- Back ID Preview -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card-container">
                                        <div class="card emergency-card">
                                            <div class="col-12">
                                                <h2>THIS IS NON-TRANSFERABLE</h2>
                                                <img src="~/img/PQ_Logo.jpg" alt="City Seal Watermark" class="watermark">
                                            </div>
                                            <div class="row p-0 m-0">
                                                <div class="col-3">
                                                    <label>Address:</label>
                                                    
                                                </div>
                                                <div class="col-9 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-address1">Apt/House Number, Bldg Name, Str Name.</p>
                                                </div>
                                                <div class="col-9 border-bottom border-dark mt-2 offset-3">
                                                    <p class="input-form-value p-0 m-0" id="preview-address2">Brgy, City, Country, Zip Code</p>
                                                </div>
                                            </div>
                                            <div class="row mt-3 p-0 m-0">
                                                <div class="col-3">
                                                    <label>Date of Birth:</label>
                                                </div>
                                                <div class="col-4 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-dob">Month Day, Year</p>
                                                </div>
                                                <div class="col-3">
                                                    <label>SEX: </label>
                                                </div>
                                                <div class="col-2 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-sex">Male</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row mt-3 p-0 m-0">
                                                <div class="col-3">
                                                    <label>Date Issued:</label>
                                                </div>
                                                <div class="col-4 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-dateissued">Month Day, Year</p>
                                                </div>
                                                <div class="col-3">
                                                    <label>Blood Type:</label>
                                                </div>
                                                <div class="col-2 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-bloodtype">X+-</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row my-4 p-0 m-0">
                                                <div class="col-12">
                                                    <label class="uppercase fw-bold">In case of emergency, please notify:</label>
                                                </div>
                                            </div>
                                            
                                            <div class="row align-items-center p-0 m-0">
                                                <div class="col-4">
                                                    <label>Parent / Guardian:</label>
                                                    
                                                </div>
                                                <div class="col-8 border-bottom border-dark d-flex align-items-center">
                                                    <p class="input-form-value p-0 m-0" id="preview-emergency-name">Juan Dela Cruz Sr.</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row p-0 m-0">
                                                <div class="col-4">
                                                    <label>Contact Number:</label>
                                                    
                                                </div>
                                                <div class="col-8 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-emergency-contact">0912-345-6789</p>
                                                </div>
                                            </div>
                                            
                                            <div class="footer-content">
                                                <h3 class="helvetica shadowed">HON. ERIC L. OLIVAREZ</h3>
                                                <p class="fw-bold">City Mayor</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printIdBtn">Print ID Card</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Print Container (hidden by default, only for printing) -->
    <div id="printContainer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999;">
        <div class="print-row">
            <div class="print-card-container">
                <div class="print-id-card">
                    <img id="printFrontImg" alt="Front ID Card">
                </div>
            </div>
            <div class="print-card-container">
                <div class="print-id-card">
                    <img id="printBackImg" alt="Back ID Card">
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden iframe for printing -->
    <iframe id="printFrame" name="printFrame" style="display: none;"></iframe>
</div>

<style>
.signature-pad-container {
    width: 100%;
    height: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #fff;
}

.signature-pad {
    width: 100%;
    height: 100%;
    cursor: crosshair;
}

.camera-preview-container {
    position: relative;
    width: 100%;
    max-width: 640px;
    margin: 0 auto;
    overflow: hidden;
    background-color: #000;
    border-radius: 8px;
}

.camera-preview {
    width: 100%;
    height: auto;
    transform: scaleX(-1); /* Mirror the preview */
}

.camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
}

.camera-guide {
    width: 320px;
    height: 320px;
    border: 2px solid rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    position: relative;
}

.guide-text {
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    background-color: rgba(0, 0, 0, 0.5);
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 14px;
}

.captured-preview-container {
    width: 100%;
    max-width: 640px;
    margin: 0 auto;
    text-align: center;
}

.captured-preview {
    max-width: 100%;
    height: auto;
    border: 2px solid #ddd;
    border-radius: 4px;
}

.camera-controls, .preview-controls {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    width: 100%;
}
</style>

@section Scripts {
    <script src="~/js/id-card-generator.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize loading modal
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingDescription = document.getElementById('loadingDescription');
            
            // Get GitHub configuration from external file
            const { username, repo, branch, token } = window.githubConfig;
            
            // Camera variables
            let photoStream = null;
            let photoDataURL = null;
            let signatureDataURL = null;
            
            // Initialize camera modal
            const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
            const signaturePadModal = new bootstrap.Modal(document.getElementById('signaturePadModal'));
            
            // Initialize signature pad
            const signaturePad = document.getElementById('signaturePad');
            const signaturePadCtx = signaturePad.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // Set canvas size
            function resizeSignaturePad() {
                const container = signaturePad.parentElement;
                signaturePad.width = container.offsetWidth;
                signaturePad.height = container.offsetHeight;
                signaturePadCtx.lineWidth = 2;
                signaturePadCtx.lineCap = 'round';
                signaturePadCtx.lineJoin = 'round';
                signaturePadCtx.strokeStyle = '#000';
            }
            
            // Initialize signature pad
            resizeSignaturePad();
            window.addEventListener('resize', resizeSignaturePad);
            
            // Signature pad event listeners
            signaturePad.addEventListener('mousedown', startDrawing);
            signaturePad.addEventListener('mousemove', draw);
            signaturePad.addEventListener('mouseup', stopDrawing);
            signaturePad.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            signaturePad.addEventListener('touchstart', handleTouch);
            signaturePad.addEventListener('touchmove', handleTouch);
            signaturePad.addEventListener('touchend', stopDrawing);
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                signaturePad.dispatchEvent(mouseEvent);
            }
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                signaturePadCtx.beginPath();
                signaturePadCtx.moveTo(lastX, lastY);
                signaturePadCtx.lineTo(e.offsetX, e.offsetY);
                signaturePadCtx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            // Clear signature button
            document.getElementById('clearSignatureBtn').addEventListener('click', function() {
                signaturePadCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
            });
            
            // Save signature button
            document.getElementById('saveSignatureBtn').addEventListener('click', function() {
                signatureDataURL = signaturePad.toDataURL('image/png');
                const signatureContainer = document.getElementById('preview-signature');
                signatureContainer.innerHTML = '';
                const img = document.createElement('img');
                img.src = signatureDataURL;
                img.style.maxHeight = '30px';
                signatureContainer.appendChild(img);
                signaturePadModal.hide();
            });
            
            // Signature pad button click handler
            document.getElementById('signaturePadBtn').addEventListener('click', function() {
                signaturePadModal.show();
            });
            
            // Photo camera button click handler
            document.getElementById('cameraBtn').addEventListener('click', function() {
                startCamera();
                cameraModal.show();
            });
            
            // Photo modal buttons
            document.getElementById('capturePhotoBtn').addEventListener('click', function() {
                captureImage();
            });
            
            document.getElementById('usePhotoBtn').addEventListener('click', function() {
                useImage();
                cameraModal.hide();
            });
            
            document.getElementById('retakePhotoBtn').addEventListener('click', function() {
                retakeImage();
            });
            
            document.getElementById('cancelPhotoBtn').addEventListener('click', function() {
                stopCamera();
                cameraModal.hide();
            });
            
            // When a file is selected for photo, preview it
            document.getElementById('photoFile').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photoDataURL = e.target.result;
                        document.getElementById('preview-photo').src = photoDataURL;
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // When a file is selected for signature, preview it
            document.getElementById('signatureFile').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        signatureDataURL = e.target.result;
                        const signatureContainer = document.getElementById('preview-signature');
                        signatureContainer.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = signatureDataURL;
                        img.style.maxHeight = '30px';
                        signatureContainer.appendChild(img);
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Modal events to stop camera when hidden
            document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
                stopCamera();
            });
            
            // Function to start the camera
            function startCamera() {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                };
                
                const videoElement = document.getElementById('cameraFeed');
                const captureBtn = document.getElementById('capturePhotoBtn');
                const useBtn = document.getElementById('usePhotoBtn');
                const retakeBtn = document.getElementById('retakePhotoBtn');
                
                // Reset UI
                videoElement.style.display = 'block';
                captureBtn.classList.remove('d-none');
                useBtn.classList.add('d-none');
                retakeBtn.classList.add('d-none');
                document.getElementById('capturedPhoto').classList.add('d-none');
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        photoStream = stream;
                        videoElement.srcObject = stream;
                    })
                    .catch(function(err) {
                        console.error("Error accessing camera: ", err);
                        alert("Could not access the camera. Please make sure camera access is enabled.");
                    });
            }
            
            // Function to stop the camera
            function stopCamera() {
                if (photoStream) {
                    photoStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    photoStream = null;
                }
            }
            
            // Function to capture image from camera
            function captureImage() {
                const videoElement = document.getElementById('cameraFeed');
                const canvasElement = document.getElementById('photoCanvas');
                const capturedImgElement = document.getElementById('capturedPhoto');
                const captureBtn = document.getElementById('capturePhotoBtn');
                const useBtn = document.getElementById('usePhotoBtn');
                const retakeBtn = document.getElementById('retakePhotoBtn');
                
                // Set canvas dimensions to match video
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // Draw the video frame to the canvas
                canvasElement.getContext('2d').drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                
                // Convert canvas to data URL
                const dataURL = canvasElement.toDataURL('image/png');
                
                // Set the captured image and data URL
                capturedImgElement.src = dataURL;
                photoDataURL = dataURL;
                
                // Update UI
                videoElement.style.display = 'none';
                capturedImgElement.classList.remove('d-none');
                captureBtn.classList.add('d-none');
                useBtn.classList.remove('d-none');
                retakeBtn.classList.remove('d-none');
            }
            
            // Function to use captured image
            function useImage() {
                document.getElementById('preview-photo').src = photoDataURL;
                stopCamera();
            }
            
            // Function to retake image
            function retakeImage() {
                const videoElement = document.getElementById('cameraFeed');
                const capturedImgElement = document.getElementById('capturedPhoto');
                const captureBtn = document.getElementById('capturePhotoBtn');
                const useBtn = document.getElementById('usePhotoBtn');
                const retakeBtn = document.getElementById('retakePhotoBtn');
                
                // Reset UI
                videoElement.style.display = 'block';
                capturedImgElement.classList.add('d-none');
                captureBtn.classList.remove('d-none');
                useBtn.classList.add('d-none');
                retakeBtn.classList.add('d-none');
            }

            if (userData) {
                // Helper function to safely set form values
                function setFormValue(elementId, value) {
                    const element = document.getElementById(elementId);
                    if (element && value) {
                        element.value = value;
                    }
                }

                // Pre-fill form with user data (only if values exist)
                setFormValue('firstName', userData.firstName);
                setFormValue('middleName', userData.middleName);
                setFormValue('lastName', userData.lastName);
                setFormValue('suffix', userData.suffix);
                setFormValue('addressLine1', userData.addressLine1);
                setFormValue('addressLine2', userData.addressLine2);
                setFormValue('dateOfBirth', userData.birthDate || userData.dateOfBirth); // Try both fields
                setFormValue('sex', userData.sex);
                setFormValue('emergencyContactName', userData.emergencyContactName);
                setFormValue('emergencyContactNo', userData.emergencyContactNumber);
                setFormValue('bloodType', userData.bloodType);
                setFormValue('disabilityType', userData.disabilityType);

                // Check if user has an existing ID card
                const idCardSnapshot = await database.ref(`users/${user.uid}/idCards`).once('value');
                const idCardData = idCardSnapshot.val();

                if (idCardData) {
                    // Pre-fill ID card specific data (only if values exist)
                    setFormValue('pwdIdNo', idCardData.pwdIdNo || userData.pwdIdNo); // Try both locations
                    setFormValue('expirationDate', idCardData.expirationDate);
                    setFormValue('dateIssued', idCardData.dateIssued);

                    // Load existing images if available
                    if (idCardData.idPhoto) {
                        document.getElementById('preview-photo').src = idCardData.idPhoto;
                        photoDataURL = idCardData.idPhoto;
                    }
                    if (idCardData.signaturePhoto) {
                        const signatureContainer = document.getElementById('preview-signature');
                        signatureContainer.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = idCardData.signaturePhoto;
                        img.style.maxHeight = '30px';
                        signatureContainer.appendChild(img);
                        signatureDataURL = idCardData.signaturePhoto;
                    }
                } else {
                    // If no ID card data exists, try to get pwdIdNo from user data
                    setFormValue('pwdIdNo', userData.pwdIdNo);
                }
            }
        });
    </script>
}