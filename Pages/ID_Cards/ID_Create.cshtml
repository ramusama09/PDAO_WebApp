@page
@model PDAO_WebApp.Pages.ID_Cards.ID_CreateModel
@{
    ViewData["Title"] = "Create PWD ID Card";
}

<link rel="stylesheet" href="~/css/id_create.css" asp-append-version="true" />
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mb-0" id="loadingMessage">Loading...</h5>
                <p class="text-muted mt-2" id="loadingDescription">Please wait while we process your request...</p>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <h2 class="mb-4">PWD ID Card Generator</h2>
    
    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        var statusMessageClass = Model.StatusMessage.StartsWith("Error") ? "danger" : "success";
        <div class="alert alert-@statusMessageClass alert-dismissible fade show" role="alert">
            @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    <form method="post" id="idCardForm" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Front ID Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="pwdIdNo" class="form-label required">PWD ID No.</label>
                            <input type="text" class="form-control" id="pwdIdNo" name="CardInfo.PwdIdNo" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="firstName" class="form-label required">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="CardInfo.FirstName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="middleName" class="form-label">Middle Name</label>
                            <input type="text" class="form-control" id="middleName" name="CardInfo.MiddleName">
                        </div>
                        
                        <div class="mb-3">
                            <label for="lastName" class="form-label required">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="CardInfo.LastName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="suffix" class="form-label">Suffix</label>
                            <input type="text" class="form-control" id="suffix" name="CardInfo.Suffix" placeholder="Jr., Sr., III, etc.">
                        </div>
                        
                        <div class="mb-3">
                            <label for="disabilityType" class="form-label required">Type of Disability</label>
                            <select class="form-select" id="disabilityType" name="CardInfo.DisabilityType" required>
                                <option value="" disabled>Select Disability Type</option>
                                <option value="Visual Impairment">Visual Impairment</option>
                                <option value="Hearing Impairment">Hearing Impairment</option>
                                <option value="Orthopedic Disability">Orthopedic Disability</option>
                                <option value="Learning Disability">Learning Disability</option>
                                <option value="Intellectual Disability">Intellectual Disability</option>
                                <option value="Psychosocial Disability">Psychosocial Disability</option>
                                <option value="Multiple Disabilities">Multiple Disabilities</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="signatureFile" class="form-label">Signature</label>
                            <input type="file" class="form-control" id="signatureFile" name="SignatureFile" accept="image/*">
                            <small class="text-muted">Upload an image of your signature</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="expirationDate" class="form-label required">Expiration Date</label>
                            <input type="date" class="form-control" id="expirationDate" name="CardInfo.ExpirationDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="photoFile" class="form-label">ID Photo</label>
                            <input type="file" class="form-control" id="photoFile" name="PhotoFile" accept="image/*">
                            <small class="text-muted">2x2 ID picture with white background</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Back ID Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="addressLine1" class="form-label required">Address Line 1</label>
                            <input type="text" class="form-control" id="addressLine1" name="CardInfo.AddressLine1" placeholder="Apt/House Number, Bldg Name, Str Name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="addressLine2" class="form-label required">Address Line 2</label>
                            <input type="text" class="form-control" id="addressLine2" name="CardInfo.AddressLine2" placeholder="Brgy, City, Country, Zip Code" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateOfBirth" class="form-label required">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="CardInfo.DateOfBirth" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateIssued" class="form-label required">Date Issued</label>
                            <input type="date" class="form-control" id="dateIssued" name="CardInfo.DateIssued" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sex" class="form-label required">Sex</label>
                            <select class="form-select" id="sex" name="CardInfo.Sex" required>
                                <option value="" disabled>Select Sex</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bloodType" class="form-label required">Blood Type</label>
                            <select class="form-select" id="bloodType" name="CardInfo.BloodType" required>
                                <option value="">Select Blood Type</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emergencyContactName" class="form-label required">Emergency Contact Name</label>
                            <input type="text" class="form-control" id="emergencyContactName" name="CardInfo.EmergencyContactName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emergencyContactNo" class="form-label required">Emergency Contact No.</label>
                            <input type="text" class="form-control" id="emergencyContactNo" name="CardInfo.EmergencyContactNo" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mb-5">
            <button type="button" id="saveIdBtn" class="btn btn-primary">Save ID Card</button>
            <button type="button" id="previewBtn" class="btn btn-secondary">Preview ID Card</button>
        </div>
    </form>
    
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">ID Card Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="idCardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="front-tab" data-bs-toggle="tab" data-bs-target="#front-tab-pane" type="button" role="tab">Front</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="back-tab" data-bs-toggle="tab" data-bs-target="#back-tab-pane" type="button" role="tab">Back</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="idCardTabContent">
                        <div class="tab-pane fade show active" id="front-tab-pane" role="tabpanel" aria-labelledby="front-tab" tabindex="0">
                            <!-- Front ID Preview -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card-container">
                                        <div class="card pwd-card">
                                            <div class="header">
                                                <div class="row p-0 m-0" style="height: 100px;">
                                                    <div class="col-3 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PH_Flag.webp" alt="Philippine Flag" class="flag" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-6 text-center p-0 m-0 d-flex flex-column justify-content-center">
                                                        <h5 class="mb-0 fw-bold">REPUBLIC OF THE PHILIPPINES</h5>
                                                        <h4 class="mb-0 helvetica shadowed">CITY OF PARAÑAQUE</h4>
                                                        <small>Persons with Disability Affairs Office</small>
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PQ_Logo.jpg" alt="City Seal" class="logo" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/BP_Logo.jpg" alt="Bagong Pilipinas Logo" class="logo" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PDAO_Logo.png" alt="PWD Logo" class="logo" style="max-height: 60px;">
                                                    </div>
                                                </div>
                                                <div class="row mt-2 p-0 m-0">
                                                    <div class="col-3"></div>
                                                    <div class="col-6 text-center p-0 m-0">
                                                        <strong>PWD ID NO: </strong><span class="underlined-text text-space" id="preview-pwdid">0000-0000-0000-0000</span>
                                                    </div>
                                                    <div class="col-3"></div>
                                                </div>
                                            </div>

                                            <div class="content">
                                                <div class="row p-0 m-0">
                                                    <div class="col-md-3 p-0 m-0">
                                                        <div class="photo-box">
                                                            <img src="~/img/default_face.jpg" id="preview-photo">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-fullname">Juan Dela Cruz</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Name</p>
                                                            </div>
                                                        </div>
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-disability">Insert Disability</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Type of Disability</p>
                                                            </div>
                                                        </div>
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-signature">Insert Signature</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Signature</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 m-0 p-0">
                                                        <div class="photo-box-no-border p-1">
                                                            <img src="~/img/qr_sample.png" alt="ID Photo">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-4">
                                                    <div class="col">
                                                        <strong>Expires on: </strong><span class="underlined-text" id="preview-expiry">Month DD, 20XX</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="footer">
                                                VALID ANYWHERE IN THE PHILIPPINES
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="back-tab-pane" role="tabpanel" aria-labelledby="back-tab" tabindex="0">
                            <!-- Back ID Preview -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card-container">
                                        <div class="card emergency-card">
                                            <div class="col-12">
                                                <h2>THIS IS NON-TRANSFERABLE</h2>
                                                <img src="~/img/PQ_Logo.jpg" alt="City Seal Watermark" class="watermark">
                                            </div>
                                            <div class="row p-0 m-0">
                                                <div class="col-3">
                                                    <label>Address:</label>
                                                    
                                                </div>
                                                <div class="col-9 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-address1">Apt/House Number, Bldg Name, Str Name.</p>
                                                </div>
                                                <div class="col-9 border-bottom border-dark mt-2 offset-3">
                                                    <p class="input-form-value p-0 m-0" id="preview-address2">Brgy, City, Country, Zip Code</p>
                                                </div>
                                            </div>
                                            <div class="row mt-3 p-0 m-0">
                                                <div class="col-3">
                                                    <label>Date of Birth:</label>
                                                </div>
                                                <div class="col-4 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-dob">Month Day, Year</p>
                                                </div>
                                                <div class="col-3">
                                                    <label>SEX: </label>
                                                </div>
                                                <div class="col-2 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-sex">Male</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row mt-3 p-0 m-0">
                                                <div class="col-3">
                                                    <label>Date Issued:</label>
                                                </div>
                                                <div class="col-4 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-dateissued">Month Day, Year</p>
                                                </div>
                                                <div class="col-3">
                                                    <label>Blood Type:</label>
                                                </div>
                                                <div class="col-2 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-bloodtype">X+-</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row my-4 p-0 m-0">
                                                <div class="col-12">
                                                    <label class="uppercase fw-bold">In case of emergency, please notify:</label>
                                                </div>
                                            </div>
                                            
                                            <div class="row align-items-center p-0 m-0">
                                                <div class="col-4">
                                                    <label>Parent / Guardian:</label>
                                                    
                                                </div>
                                                <div class="col-8 border-bottom border-dark d-flex align-items-center">
                                                    <p class="input-form-value p-0 m-0" id="preview-emergency-name">Juan Dela Cruz Sr.</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row p-0 m-0">
                                                <div class="col-4">
                                                    <label>Contact Number:</label>
                                                    
                                                </div>
                                                <div class="col-8 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-emergency-contact">0912-345-6789</p>
                                                </div>
                                            </div>
                                            
                                            <div class="footer-content">
                                                <h3 class="helvetica shadowed">HON. ERIC L. OLIVAREZ</h3>
                                                <p class="fw-bold">City Mayor</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printIdBtn">Print ID Card</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Print Container (hidden by default, only for printing) -->
    <div id="printContainer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999;">
        <div class="print-row">
            <div class="print-card-container">
                <div class="print-id-card">
                    <img id="printFrontImg" alt="Front ID Card">
                </div>
            </div>
            <div class="print-card-container">
                <div class="print-id-card">
                    <img id="printBackImg" alt="Back ID Card">
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden iframe for printing -->
    <iframe id="printFrame" name="printFrame" style="display: none;"></iframe>
</div>

@section Scripts {
    <script src="~/js/id-card-generator.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize loading modal
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingDescription = document.getElementById('loadingDescription');

            // Check authentication state
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    // Redirect to login if not authenticated
                    window.location.href = '/Identity/Login';
                    return;
                }

                try {
                    // Show loading modal for form pre-filling
                    loadingMessage.textContent = 'Loading User Data';
                    loadingDescription.textContent = 'Please wait while we fetch your information...';
                    loadingModal.show();

                    // Get user data from Firebase
                    const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                    const userData = userSnapshot.val();

                    if (userData) {
                        // Helper function to safely set form values
                        function setFormValue(elementId, value) {
                            const element = document.getElementById(elementId);
                            if (element && value) {
                                element.value = value;
                            }
                        }

                        // Pre-fill form with user data (only if values exist)
                        setFormValue('firstName', userData.firstName);
                        setFormValue('middleName', userData.middleName);
                        setFormValue('lastName', userData.lastName);
                        setFormValue('suffix', userData.suffix);
                        setFormValue('addressLine1', userData.addressLine1);
                        setFormValue('addressLine2', userData.addressLine2);
                        setFormValue('dateOfBirth', userData.birthDate);
                        setFormValue('sex', userData.sex);
                        setFormValue('emergencyContactName', userData.emergencyContactName);
                        setFormValue('emergencyContactNo', userData.emergencyContactNumber);

                        // Check if user has an existing ID card
                        const idCardSnapshot = await database.ref(`users/${user.uid}/idCards`).once('value');
                        const idCardData = idCardSnapshot.val();

                        if (idCardData) {
                            // Pre-fill ID card specific data (only if values exist)
                            setFormValue('pwdIdNo', idCardData.pwdIdNo);
                            setFormValue('disabilityType', idCardData.disabilityType);
                            setFormValue('expirationDate', idCardData.expirationDate);
                            setFormValue('dateIssued', idCardData.dateIssued);
                            setFormValue('bloodType', idCardData.bloodType);

                            // Load existing images if available
                            if (idCardData.photoID) {
                                document.getElementById('preview-photo').src = idCardData.photoID;
                            }
                            if (idCardData.signature) {
                                const signatureContainer = document.getElementById('preview-signature');
                                signatureContainer.innerHTML = '';
                                const img = document.createElement('img');
                                img.src = idCardData.signature;
                                img.style.maxHeight = '30px';
                                signatureContainer.appendChild(img);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    // Don't show error alert for missing data, just log it
                    console.log('Some user data may be missing, continuing with form...');
                } finally {
                    // Hide loading modal after form is pre-filled
                    loadingModal.hide();
                }
            });

            // Save ID Card button click handler
            document.getElementById('saveIdBtn').addEventListener('click', async function(e) {
                e.preventDefault();

                // Validate form
                if (!document.getElementById('idCardForm').checkValidity()) {
                    document.getElementById('idCardForm').reportValidity();
                    return;
                }

                try {
                    const user = auth.currentUser;
                    if (!user) {
                        throw new Error('User not authenticated');
                    }

                    // Show loading modal for saving
                    loadingMessage.textContent = 'Saving ID Card';
                    loadingDescription.textContent = 'Please wait while we process and save your ID card...';
                    loadingModal.show();

                    console.log('Starting ID card save process...');
                    console.log('Current user:', user.uid);

                    // Function to update preview with form values
                    function updatePreview() {
                        // Front ID
                        document.getElementById('preview-pwdid').textContent = document.getElementById('pwdIdNo').value || '0000-0000-0000-0000';
                        
                        // Full name
                        var firstName = document.getElementById('firstName').value || '';
                        var middleName = document.getElementById('middleName').value || '';
                        var lastName = document.getElementById('lastName').value || '';
                        var suffix = document.getElementById('suffix').value || '';
                        
                        // Format name
                        var middleInitial = middleName ? middleName.charAt(0) + '. ' : '';
                        var fullName = firstName + ' ' + middleInitial + lastName + (suffix ? ', ' + suffix : '');
                        document.getElementById('preview-fullname').textContent = fullName || 'Juan Dela Cruz';
                        
                        // Disability
                        var disability = document.getElementById('disabilityType');
                        document.getElementById('preview-disability').textContent = 
                            disability.options[disability.selectedIndex].value || 'Insert Disability';
                        
                        // Expiry
                        var expiryDate = document.getElementById('expirationDate').value;
                        if (expiryDate) {
                            var date = new Date(expiryDate);
                            var options = { year: 'numeric', month: 'long', day: 'numeric' };
                            document.getElementById('preview-expiry').textContent = date.toLocaleDateString('en-US', options);
                        }
                        
                        // Back ID
                        document.getElementById('preview-address1').textContent = 
                            document.getElementById('addressLine1').value || 'Apt/House Number, Bldg Name, Str Name.';
                        document.getElementById('preview-address2').textContent = 
                            document.getElementById('addressLine2').value || 'Brgy, City, Country, Zip Code';
                        
                        // Date of birth
                        var dobDate = document.getElementById('dateOfBirth').value;
                        if (dobDate) {
                            var date = new Date(dobDate);
                            var options = { year: 'numeric', month: 'long', day: 'numeric' };
                            document.getElementById('preview-dob').textContent = date.toLocaleDateString('en-US', options);
                        }
                        
                        // Date issued
                        var issuedDate = document.getElementById('dateIssued').value;
                        if (issuedDate) {
                            var date = new Date(issuedDate);
                            var options = { year: 'numeric', month: 'long', day: 'numeric' };
                            document.getElementById('preview-dateissued').textContent = date.toLocaleDateString('en-US', options);
                        }
                        
                        // Sex
                        var sex = document.getElementById('sex');
                        document.getElementById('preview-sex').textContent = 
                            sex.options[sex.selectedIndex].value || 'Male';
                        
                        // Blood type
                        var bloodType = document.getElementById('bloodType');
                        document.getElementById('preview-bloodtype').textContent = 
                            bloodType.options[bloodType.selectedIndex].value || 'X+-';
                        
                        // Emergency contact
                        document.getElementById('preview-emergency-name').textContent = 
                            document.getElementById('emergencyContactName').value || 'Juan Dela Cruz Sr.';
                        document.getElementById('preview-emergency-contact').textContent = 
                            document.getElementById('emergencyContactNo').value || '0912-345-6789';
                    }

                    // Update preview with form values
                    console.log('Updating preview with form values...');
                    updatePreview();
                    console.log('Preview updated successfully');

                    // Show the modal first (we need the elements to be visible for html2canvas)
                    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                    previewModal.show();

                    // Wait for modal to be fully visible
                    setTimeout(async function() {
                        try {
                            console.log('Modal shown, preparing to capture front ID...');
                            const frontTab = document.getElementById('front-tab');
                            const backTab = document.getElementById('back-tab');

                            // Make sure front tab is active
                            frontTab.click();

                            // Wait for tab to be visible
                            setTimeout(async function() {
                                try {
                                    console.log('Capturing front ID...');
                                    // Capture front ID card
                                    const frontElement = document.querySelector('#front-tab-pane .card');
                                    if (!frontElement) {
                                        throw new Error('Front ID card element not found');
                                    }
                                    console.log('Front element found, generating canvas...');
                                    
                                    const frontCanvas = await html2canvas(frontElement, {
                                        scale: 3,
                                        backgroundColor: null,
                                        useCORS: true,
                                        width: 800,
                                        height: 800 * (2.125/3.375)
                                    });
                                    console.log('Front canvas generated');
                                    const frontDataURL = frontCanvas.toDataURL('image/png');
                                    console.log('Front data URL generated');

                                    // Now switch to back tab
                                    backTab.click();

                                    // Wait for back tab to be visible
                                    setTimeout(async function() {
                                        try {
                                            console.log('Capturing back ID...');
                                            const backElement = document.querySelector('#back-tab-pane .card');
                                            if (!backElement) {
                                                throw new Error('Back ID card element not found');
                                            }
                                            console.log('Back element found, generating canvas...');
                                            
                                            const backCanvas = await html2canvas(backElement, {
                                                scale: 3,
                                                backgroundColor: null,
                                                useCORS: true,
                                                width: 800,
                                                height: 800 * (2.125/3.375)
                                            });
                                            console.log('Back canvas generated');
                                            const backDataURL = backCanvas.toDataURL('image/png');
                                            console.log('Back data URL generated');

                                            // Get photo and signature data
                                            console.log('Processing photo and signature...');
                                            const photoFile = document.getElementById('photoFile').files[0];
                                            const signatureFile = document.getElementById('signatureFile').files[0];
                                            let photoDataURL = null;
                                            let signatureDataURL = null;

                                            if (photoFile) {
                                                console.log('Reading photo file...');
                                                photoDataURL = await readFileAsDataURL(photoFile);
                                                console.log('Photo data URL generated');
                                            }
                                            if (signatureFile) {
                                                console.log('Reading signature file...');
                                                signatureDataURL = await readFileAsDataURL(signatureFile);
                                                console.log('Signature data URL generated');
                                            }

                                            // Prepare ID card data
                                            console.log('Preparing ID card data for Firebase...');
                                            const idCardData = {
                                                pwdIdNo: document.getElementById('pwdIdNo').value,
                                                disabilityType: document.getElementById('disabilityType').value,
                                                expirationDate: document.getElementById('expirationDate').value,
                                                dateIssued: document.getElementById('dateIssued').value,
                                                bloodType: document.getElementById('bloodType').value,
                                                frontID: frontDataURL,
                                                backID: backDataURL
                                            };

                                            if (photoDataURL) {
                                                idCardData.photoID = photoDataURL;
                                            }
                                            if (signatureDataURL) {
                                                idCardData.signature = signatureDataURL;
                                            }

                                            console.log('Saving to Firebase...');
                                            console.log('Data size:', JSON.stringify(idCardData).length, 'bytes');
                                            
                                            // Save to Firebase
                                            await database.ref(`users/${user.uid}/idCards`).set(idCardData);
                                            console.log('Successfully saved to Firebase');

                                            // Show success message and redirect
                                            loadingDescription.textContent = 'Generating ID card images...';
                                            setTimeout(function() {
                                                loadingDescription.textContent = 'Processing images and saving data...';
                                            }, 1000);
                                            setTimeout(function() {
                                                loadingModal.hide();
                                                alert('ID Card saved successfully!');
                                                window.location.href = '/ID_Cards/ID_Index';
                                            }, 2000);
                                        } catch (error) {
                                            console.error('Error in back ID capture:', error);
                                            throw error;
                                        }
                                    }, 300);
                                } catch (error) {
                                    console.error('Error in front ID capture:', error);
                                    throw error;
                                }
                            }, 300);
                        } catch (error) {
                            console.error('Error in modal handling:', error);
                            throw error;
                        }
                    }, 500);
                } catch (error) {
                    console.error('Error saving ID card:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    loadingModal.hide();
                    alert('Error saving ID card: ' + error.message);
                }
            });
        });

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }
    </script>
} 