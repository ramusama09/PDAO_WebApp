@page
@model PDAO_WebApp.Pages.ID_Cards.ID_CreateModel
@{
    ViewData["Title"] = "Create PWD ID Card";
}

<link rel="stylesheet" href="~/css/id_create.css" asp-append-version="true" />
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<div class="container mt-4">
    <h2 class="mb-4">PWD ID Card Generator</h2>
    
    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        var statusMessageClass = Model.StatusMessage.StartsWith("Error") ? "danger" : "success";
        <div class="alert alert-@statusMessageClass alert-dismissible fade show" role="alert">
            @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    <form method="post" id="idCardForm" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Front ID Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="pwdIdNo" class="form-label required">PWD ID No.</label>
                            <input type="text" class="form-control" id="pwdIdNo" name="CardInfo.PwdIdNo" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="firstName" class="form-label required">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="CardInfo.FirstName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="middleName" class="form-label">Middle Name</label>
                            <input type="text" class="form-control" id="middleName" name="CardInfo.MiddleName">
                        </div>
                        
                        <div class="mb-3">
                            <label for="lastName" class="form-label required">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="CardInfo.LastName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="suffix" class="form-label">Suffix</label>
                            <input type="text" class="form-control" id="suffix" name="CardInfo.Suffix" placeholder="Jr., Sr., III, etc.">
                        </div>
                        
                        <div class="mb-3">
                            <label for="disabilityType" class="form-label required">Type of Disability</label>
                            <select class="form-select" id="disabilityType" name="CardInfo.DisabilityType" required>
                                <option value="">Select Disability Type</option>
                                <option value="Visual Impairment">Visual Impairment</option>
                                <option value="Hearing Impairment">Hearing Impairment</option>
                                <option value="Orthopedic Disability">Orthopedic Disability</option>
                                <option value="Learning Disability">Learning Disability</option>
                                <option value="Intellectual Disability">Intellectual Disability</option>
                                <option value="Psychosocial Disability">Psychosocial Disability</option>
                                <option value="Multiple Disabilities">Multiple Disabilities</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="signatureFile" class="form-label">Signature</label>
                            <input type="file" class="form-control" id="signatureFile" name="SignatureFile" accept="image/*">
                            <small class="text-muted">Upload an image of your signature</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="expirationDate" class="form-label required">Expiration Date</label>
                            <input type="date" class="form-control" id="expirationDate" name="CardInfo.ExpirationDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="photoFile" class="form-label">ID Photo</label>
                            <input type="file" class="form-control" id="photoFile" name="PhotoFile" accept="image/*">
                            <small class="text-muted">2x2 ID picture with white background</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Back ID Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="addressLine1" class="form-label required">Address Line 1</label>
                            <input type="text" class="form-control" id="addressLine1" name="CardInfo.AddressLine1" placeholder="Apt/House Number, Bldg Name, Str Name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="addressLine2" class="form-label required">Address Line 2</label>
                            <input type="text" class="form-control" id="addressLine2" name="CardInfo.AddressLine2" placeholder="Brgy, City, Country, Zip Code" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateOfBirth" class="form-label required">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="CardInfo.DateOfBirth" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateIssued" class="form-label required">Date Issued</label>
                            <input type="date" class="form-control" id="dateIssued" name="CardInfo.DateIssued" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sex" class="form-label required">Sex</label>
                            <select class="form-select" id="sex" name="CardInfo.Sex" required>
                                <option value="">Select Sex</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bloodType" class="form-label required">Blood Type</label>
                            <select class="form-select" id="bloodType" name="CardInfo.BloodType" required>
                                <option value="">Select Blood Type</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emergencyContactName" class="form-label required">Emergency Contact Name</label>
                            <input type="text" class="form-control" id="emergencyContactName" name="CardInfo.EmergencyContactName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emergencyContactNo" class="form-label required">Emergency Contact No.</label>
                            <input type="text" class="form-control" id="emergencyContactNo" name="CardInfo.EmergencyContactNo" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mb-5">
            <button type="button" id="generateAndDownloadBtn" class="btn btn-primary">Generate ID Card</button>
            <button type="button" id="previewBtn" class="btn btn-secondary">Preview ID Card</button>
        </div>
    </form>
    
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">ID Card Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="idCardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="front-tab" data-bs-toggle="tab" data-bs-target="#front-tab-pane" type="button" role="tab">Front</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="back-tab" data-bs-toggle="tab" data-bs-target="#back-tab-pane" type="button" role="tab">Back</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="idCardTabContent">
                        <div class="tab-pane fade show active" id="front-tab-pane" role="tabpanel" aria-labelledby="front-tab" tabindex="0">
                            <!-- Front ID Preview -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card-container">
                                        <div class="card pwd-card">
                                            <div class="header">
                                                <div class="row p-0 m-0" style="height: 100px;">
                                                    <div class="col-3 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PH_Flag.webp" alt="Philippine Flag" class="flag" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-6 text-center p-0 m-0 d-flex flex-column justify-content-center">
                                                        <h5 class="mb-0 fw-bold">REPUBLIC OF THE PHILIPPINES</h5>
                                                        <h4 class="mb-0 helvetica shadowed">CITY OF PARAÃ‘AQUE</h4>
                                                        <small>Persons with Disability Affairs Office</small>
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PQ_Logo.jpg" alt="City Seal" class="logo" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/BP_Logo.jpg" alt="Bagong Pilipinas Logo" class="logo" style="max-height: 60px;">
                                                    </div>
                                                    <div class="col-1 p-0 m-0 d-flex justify-content-center align-items-center">
                                                        <img src="~/img/PDAO_Logo.png" alt="PWD Logo" class="logo" style="max-height: 60px;">
                                                    </div>
                                                </div>
                                                <div class="row mt-2 p-0 m-0">
                                                    <div class="col-3"></div>
                                                    <div class="col-6 text-center p-0 m-0">
                                                        <strong>PWD ID NO: </strong><span class="underlined-text text-space" id="preview-pwdid">0000-0000-0000-0000</span>
                                                    </div>
                                                    <div class="col-3"></div>
                                                </div>
                                            </div>

                                            <div class="content">
                                                <div class="row p-0 m-0">
                                                    <div class="col-md-3 p-0 m-0">
                                                        <div class="photo-box">
                                                            <img src="~/img/default_face.jpg" id="preview-photo">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-fullname">Juan Dela Cruz</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Name</p>
                                                            </div>
                                                        </div>
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-disability">Insert Disability</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Type of Disability</p>
                                                            </div>
                                                        </div>
                                                        <div class="row my-2">
                                                            <div class="col-10 offset-1 border-bottom border-dark">
                                                                <p class="p-0 m-0 text-center helvetica fs-5" id="preview-signature">Insert Signature</p>
                                                            </div>
                                                            <div class="col-10 offset-1">
                                                                <p class="p-0 m-0 text-center fw-bold">Signature</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 m-0 p-0">
                                                        <div class="photo-box-no-border p-1">
                                                            <img src="~/img/qr_sample.png" alt="ID Photo">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-4">
                                                    <div class="col">
                                                        <strong>Expires on: </strong><span class="underlined-text" id="preview-expiry">Month DD, 20XX</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="footer">
                                                VALID ANYWHERE IN THE PHILIPPINES
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="back-tab-pane" role="tabpanel" aria-labelledby="back-tab" tabindex="0">
                            <!-- Back ID Preview -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card-container">
                                        <div class="card emergency-card">
                                            <div class="col-12">
                                                <h2>THIS IS NON-TRANSFERABLE</h2>
                                                <img src="~/img/PQ_Logo.jpg" alt="City Seal Watermark" class="watermark">
                                            </div>
                                            <div class="row p-0 m-0">
                                                <div class="col-3">
                                                    <label>Address:</label>
                                                    
                                                </div>
                                                <div class="col-9 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-address1">Apt/House Number, Bldg Name, Str Name.</p>
                                                </div>
                                                <div class="col-9 border-bottom border-dark mt-2 offset-3">
                                                    <p class="input-form-value p-0 m-0" id="preview-address2">Brgy, City, Country, Zip Code</p>
                                                </div>
                                            </div>
                                            <div class="row mt-3 p-0 m-0">
                                                <div class="col-3">
                                                    <label>Date of Birth:</label>
                                                </div>
                                                <div class="col-4 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-dob">Month Day, Year</p>
                                                </div>
                                                <div class="col-3">
                                                    <label>SEX: </label>
                                                </div>
                                                <div class="col-2 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-sex">Male</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row mt-3 p-0 m-0">
                                                <div class="col-3">
                                                    <label>Date Issued:</label>
                                                </div>
                                                <div class="col-4 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-dateissued">Month Day, Year</p>
                                                </div>
                                                <div class="col-3">
                                                    <label>Blood Type:</label>
                                                </div>
                                                <div class="col-2 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-bloodtype">X+-</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row my-4 p-0 m-0">
                                                <div class="col-12">
                                                    <label class="uppercase fw-bold">In case of emergency, please notify:</label>
                                                </div>
                                            </div>
                                            
                                            <div class="row align-items-center p-0 m-0">
                                                <div class="col-4">
                                                    <label>Parent / Guardian:</label>
                                                    
                                                </div>
                                                <div class="col-8 border-bottom border-dark d-flex align-items-center">
                                                    <p class="input-form-value p-0 m-0" id="preview-emergency-name">Juan Dela Cruz Sr.</p>
                                                </div>
                                            </div>
                                            
                                            <div class="row p-0 m-0">
                                                <div class="col-4">
                                                    <label>Contact Number:</label>
                                                    
                                                </div>
                                                <div class="col-8 border-bottom border-dark">
                                                    <p class="input-form-value p-0 m-0" id="preview-emergency-contact">0912-345-6789</p>
                                                </div>
                                            </div>
                                            
                                            <div class="footer-content">
                                                <h3 class="helvetica shadowed">HON. ERIC L. OLIVAREZ</h3>
                                                <p class="fw-bold">City Mayor</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printIdBtn">Print ID Card</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden iframe for printing -->
    <iframe id="printFrame" name="printFrame" style="display: none;"></iframe>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize dates
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('dateIssued').value = today;
            
            // Default expiration date (3 years from today)
            var expDate = new Date();
            expDate.setFullYear(expDate.getFullYear() + 3);
            document.getElementById('expirationDate').value = expDate.toISOString().split('T')[0];
            
            // Preview button click handler
            document.getElementById('previewBtn').addEventListener('click', function() {
                updatePreview();
                var previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                previewModal.show();
            });
            
            // Print button click handler
            document.getElementById('printIdBtn').addEventListener('click', function() {
                // Capture both sides of the ID
                console.log("Print button clicked, capturing ID cards");
                
                // Make sure front tab is active
                var frontTab = document.getElementById('front-tab');
                frontTab.click();
                
                // Wait for tab to be visible
                setTimeout(function() {
                    // Capture front ID
                    var frontElement = document.querySelector('#front-tab-pane .card');
                    html2canvas(frontElement, {
                        scale: 2,
                        backgroundColor: null,
                        useCORS: true
                    }).then(function(frontCanvas) {
                        var frontDataURL = frontCanvas.toDataURL('image/png');
                        
                        // Now capture back ID
                        var backTab = document.getElementById('back-tab');
                        backTab.click();
                        
                        // Wait for back tab to be visible
                        setTimeout(function() {
                            var backElement = document.querySelector('#back-tab-pane .card');
                            html2canvas(backElement, {
                                scale: 2,
                                backgroundColor: null,
                                useCORS: true
                            }).then(function(backCanvas) {
                                var backDataURL = backCanvas.toDataURL('image/png');
                                
                                // Create a new window for printing
                                var printWindow = window.open('', '_blank');
                                printWindow.document.write('<html><head><title>Print ID Card</title>');
                                printWindow.document.write('<style>');
                                printWindow.document.write('@@media print {');
                                printWindow.document.write('  @@page { size: landscape; margin: 0; }');
                                printWindow.document.write('  body { margin: 0; padding: 0; }');
                                printWindow.document.write('  .container { display: flex; justify-content: space-around; align-items: center; height: 100vh; }');
                                printWindow.document.write('  img { max-height: 95vh; width: auto; }');
                                printWindow.document.write('}');
                                printWindow.document.write('body { margin: 0; padding: 0; background-color: white; }');
                                printWindow.document.write('.container { display: flex; justify-content: space-around; align-items: center; height: 100vh; }');
                                printWindow.document.write('img { max-height: 95vh; width: auto; }');
                                printWindow.document.write('</style>');
                                printWindow.document.write('</head><body>');
                                printWindow.document.write('<div class="container">');
                                printWindow.document.write('<img src="' + frontDataURL + '">');
                                printWindow.document.write('<img src="' + backDataURL + '">');
                                printWindow.document.write('</div>');
                                printWindow.document.write('</body></html>');
                                printWindow.document.close();
                                
                                // Print after delay
                                setTimeout(function() {
                                    printWindow.print();
                                    // Close window after printing
                                    setTimeout(function() {
                                        printWindow.close();
                                    }, 500);
                                }, 500);
                            });
                        }, 300);
                    });
                }, 300);
            });
            
            // Download button click handler
            document.getElementById('generateAndDownloadBtn').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Basic validation
                if (!document.getElementById('idCardForm').checkValidity()) {
                    document.getElementById('idCardForm').reportValidity();
                    return;
                }
                
                // Update preview
                updatePreview();
                
                // Show modal
                var previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                previewModal.show();
                
                // Wait for modal to be visible
                setTimeout(function() {
                    // Capture front ID
                    document.getElementById('front-tab').click();
                    setTimeout(function() {
                        var frontElement = document.querySelector('#front-tab-pane .card');
                        html2canvas(frontElement).then(function(canvas) {
                            var dataURL = canvas.toDataURL('image/png');
                            var lastName = document.getElementById('lastName').value || 'Lastname';
                            var firstName = document.getElementById('firstName').value || 'Firstname';
                            downloadImage(dataURL, lastName + firstName + '_Front_ID.png');
                            
                            // Capture back ID
                            document.getElementById('back-tab').click();
                            setTimeout(function() {
                                var backElement = document.querySelector('#back-tab-pane .card');
                                html2canvas(backElement).then(function(canvas) {
                                    var dataURL = canvas.toDataURL('image/png');
                                    downloadImage(dataURL, lastName + firstName + '_Back_ID.png');
                                    
                                    // Submit form after downloads
                                    document.getElementById('idCardForm').submit();
                                });
                            }, 300);
                        });
                    }, 300);
                }, 500);
            });
            
            function downloadImage(dataURL, fileName) {
                var link = document.createElement('a');
                link.download = fileName;
                link.href = dataURL;
                link.click();
            }
            
            function updatePreview() {
                // Update preview fields with form values
                // Update all the preview fields here
            }
        });
    </script>
} 